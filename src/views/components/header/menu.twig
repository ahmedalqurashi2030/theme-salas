{# تجهيز بيانات الميجا منيو #}
{% set mega_items = [] %}
{% for m in menus %}
    {% if m.has_children %}{% set mega_items = mega_items|merge([m]) %}{% endif %}
{% endfor %}

{# === DESKTOP MENU === #}
<div class="flex items-center h-full gap-8">
    
    {# 1. زر جميع الأقسام (Mega Menu) #}
    <div class="th-all-cats-wrapper group">
        <div class="th-all-cats-btn">
            <i class="sicon-layout-grid text-lg"></i>
            <span>جميع الأقسام</span>
            <i class="sicon-keyboard_arrow_down text-xs opacity-50 mt-1 mr-auto"></i>
        </div>

        <div class="th-mega-menu">
            {# القائمة الجانبية #}
            <div class="th-mega-sidebar">
                {% for item in mega_items %}
                    <div class="th-mega-tab {{ loop.first ? 'active' : '' }}" onmouseover="tharaaOpenTab(event, 'mega-{{ loop.index }}')">
                        {{ item.title }}
                   
					{% if item.image %}
		<img src="{{ item.image }}" alt="{{ item.title }}" class="w-8 h-8 rounded-full object-cover bg-gray-50">
		{% else %}
		<span class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 text-xs">
			<i class="sicon-layout-grid"></i>
		</span>
		{% endif %}
		 </div>
                    
                {% endfor %}
            </div>
            {# المحتوى #}
            <div class="th-mega-content overflow-y-auto">
                {% for item in mega_items %}
                    <div id="mega-{{ loop.index }}" class="th-mega-pane {{ loop.first ? 'active' : '' }}">
                        <div class="grid grid-cols-3 gap-8">
                            {% for child in item.children %}
                                <div>
                                    <a href="{{ child.url }}" class="font-bold text-gray-800 mb-3 block hover:text-gold transition flex items-center gap-2">
                                        {# أيقونة افتراضية #}
                                         {% if child.image %}
      <img src="{{ child.image }}" alt="{{ child.title }}" class="w-8 h-8 rounded-full object-cover bg-gray-50">
    {% else %}
      <span class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 text-xs">
        <i class="sicon-layout-grid"></i>
      </span>
    {% endif %}
                                        {{ child.title }}
										
                                    </a>
                                    <ul class="space-y-2 pr-10 border-r border-gray-50">
                                        {% for sub in child.children %}
                                            <li><a href="{{ sub.url }}" class="text-sm text-gray-500 hover:text-gold transition block hover:translate-x-[-3px]">{{ sub.title }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        </div>
                        {# منتجات مقترحة #}
                        {% if item.products %}
    <div class="mt-8 pt-6 border-t border-gray-100">
        <h4 class="font-bold mb-4 text-sm text-gold">منتجات مميزة</h4>
        <div class="grid grid-cols-4 gap-4">
            {% for product in item.products|slice(0, 4) %}
                <thraa-product-card 
                    shadow-on-hover 
                    product="{{ product }}"
                    class="text-xs">
                </thraa-product-card>
            {% endfor %}
        </div>
    </div>
{% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# 2. الروابط الرئيسية (Cascading) #}
    <ul class="flex items-center gap-6 h-full">
        {% for menu in menus %}
            {% include 'components.header._menu-item' with { is_root: true } %}
        {% endfor %}
    </ul>
</div>

{# === MOBILE DRAWER === #}
<div class="mobile-overlay" id="mobile-overlay" onclick="toggleDrawer()"></div>
<div class="mobile-drawer flex flex-col" id="mobile-drawer">
    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <span class="font-bold text-lg">القائمة</span>
        <button onclick="toggleDrawer()" class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center text-red-500">
            <i class="sicon-cancel"></i>
        </button>
    </div>
    
    <div class="flex-1 overflow-y-auto p-2">
        <ul class="space-y-1">
            {% for menu in menus %}
                {% include 'components.header._menu-item' with { is_mobile: true } %}
            {% endfor %}
        </ul>
    </div>

    <div class="p-4 border-t border-gray-100 bg-gray-50">
        {% if user.type == 'user' %}
            <a href="{{ link('profile') }}" class="block text-center py-3 bg-white border border-gray-200 rounded-lg font-bold text-gray-700">حسابي</a>
        {% else %}
            <button onclick="salla.event.dispatch('login::open')" class="w-full py-3 bg-black text-white rounded-lg font-bold hover:bg-gold transition">تسجيل الدخول</button>
        {% endif %}
    </div>
</div>

<script>
    function tharaaOpenTab(evt, id) {
        document.querySelectorAll('.th-mega-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.th-mega-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    function toggleDrawer() {
        document.getElementById('mobile-drawer').classList.toggle('open');
        document.getElementById('mobile-overlay').classList.toggle('open');
    }
</script>