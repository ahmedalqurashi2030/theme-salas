{# src/views/components/header/menu.twig #}

{# تجهيز بيانات الميجا منيو #}
{% set mega_items = [] %}
{% for m in menus %}
    {% if m.has_children %}{% set mega_items = mega_items|merge([m]) %}{% endif %}
{% endfor %}

<div class="flex items-center h-full gap-8">
    
    {# === زر جميع الأقسام (Mega Menu) === #}
    <div class="group h-full relative">
        <div class="th-all-cats">
            <i class="sicon-layout-grid text-lg"></i>
            <span>جميع الأقسام</span>
        </div>

        {# محتوى الميجا #}
        <div class="th-dropdown th-mega-menu">
            {# القائمة الجانبية #}
            <div class="w-1/4 bg-gray-50 border-l border-gray-100 py-3">
                {% for item in mega_items %}
                    <div class="th-tab-link {{ loop.first ? 'active' : '' }}" onmouseover="openMegaTab(event, 'tab-{{ loop.index }}')">
                        {{ item.title }}
                        <i class="sicon-keyboard_arrow_left text-xs opacity-50"></i>
                    </div>
                {% endfor %}
            </div>
            {# المحتوى #}
            <div class="w-3/4 p-8 overflow-y-auto">
                {% for item in mega_items %}
                    <div id="tab-{{ loop.index }}" class="mega-pane {{ loop.first ? '' : 'hidden' }}">
                        <div class="grid grid-cols-3 gap-8">
                            {% for child in item.children %}
                                <div>
                                    <a href="{{ child.url }}" class="font-bold text-gray-800 mb-3 block hover:text-gold transition flex items-center gap-2">
                                        {# صورة افتراضية إذا لم توجد #}
                                        <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-400">
                                            <i class="sicon-layout-grid"></i>
                                        </span>
                                        {{ child.title }}
                                    </a>
                                    <ul class="space-y-2 pr-10">
                                        {% for sub in child.children %}
                                            <li><a href="{{ sub.url }}" class="text-sm text-gray-500 hover:text-gold transition block hover:translate-x-[-5px]">{{ sub.title }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# === الروابط الرئيسية (Cascading) === #}
    <ul class="flex items-center gap-8 h-full">
        {% for menu in menus %}
            {% include 'components.header._menu-item' with { is_root: true } %}
        {% endfor %}
    </ul>
</div>

{# === قائمة الموبايل الاحترافية (Mobile Drawer) === #}
<div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>
<div id="mobile-drawer" class="mobile-drawer flex flex-col">
    {# رأس القائمة #}
    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <span class="font-bold text-lg">القائمة</span>
        <button onclick="toggleMobileMenu()" class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center text-red-500">
            <i class="sicon-cancel"></i>
        </button>
    </div>
    
    {# محتوى القائمة #}
    <div class="flex-1 overflow-y-auto p-4">
        <ul class="space-y-1">
            {% for menu in menus %}
                {% include 'components.header._menu-item' with { is_mobile: true } %}
            {% endfor %}
        </ul>
    </div>

    {# ذيل القائمة #}
    <div class="p-4 border-t border-gray-100 bg-gray-50">
        {% if user.type == 'user' %}
            <a href="{{ link('profile') }}" class="block text-center py-2 font-bold text-gray-700">حسابي</a>
        {% else %}
            <button onclick="salla.event.dispatch('login::open')" class="w-full py-3 bg-black text-white rounded-lg font-bold">تسجيل الدخول</button>
        {% endif %}
    </div>
</div>

<script>
    // دوال التحكم
    function openMegaTab(evt, id) {
        document.querySelectorAll('.mega-pane').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.th-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        evt.currentTarget.classList.add('active');
    }

    function toggleMobileMenu() {
        document.getElementById('mobile-drawer').classList.toggle('is-open');
        document.getElementById('mobile-overlay').classList.toggle('is-open');
    }
</script>