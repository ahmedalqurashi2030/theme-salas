{# ===========================
   Tharaa Menu Item (Upgraded)
   - يحافظ على بنية سلة (attrs/link_attrs/children/products)
   - يضيف: Mobile Accordion + Cascading Flyout + Mega styling
   =========================== #}

{# =================
   MOBILE (Accordion)
   ================= #}
<li class="lg:hidden th-hdr__m-item" {{ menu.attrs|raw }}>
  {% if not menu.has_children %}
    <a {{ menu.link_attrs|raw }} href="{{ menu.url }}" class="th-hdr__m-link">{{ menu.title }}</a>
  {% else %}
    <div class="th-hdr__m-row">
      <a {{ menu.link_attrs|raw }} href="{{ menu.url }}" class="th-hdr__m-link th-hdr__m-link--parent">{{ menu.title }}</a>
      <button type="button"
              class="th-hdr__m-toggle"
              data-th-acc-toggle
              aria-expanded="false"
              aria-label="فتح/إغلاق">
        <span class="th-hdr__m-plus">+</span>
      </button>
    </div>

    <ul class="th-hdr__m-sub" data-th-acc-panel hidden>
      {% for submenu in menu.children %}
        {% include _self with {menu:submenu} %}
      {% endfor %}
    </ul>
  {% endif %}
</li>

{# =================
   DESKTOP (Cascading)
   ================= #}
<li class="!hidden lg:!block th-hdr__item
    {{ is_root_menu ? 'root-level lg:!inline-block' : 'relative' }}
    {{ menu.products ? ' mega-menu' : '' }}
    {{ menu.has_children ? ' has-children' : '' }}"
    {{ menu.attrs|raw }}>

  <a {{ menu.link_attrs|raw }} href="{{ menu.url }}" class="th-hdr__link">
    <span class="th-hdr__linkText">{{ menu.title }}</span>
    {% if menu.has_children %}
      <span class="th-hdr__chev {{ is_root_menu ? 'is-down' : 'is-side' }}" aria-hidden="true">{{ is_root_menu ? '⌄' : '‹' }}</span>
    {% endif %}
  </a>

  {% if menu.has_children %}
    <div class="sub-menu th-hdr__dropdown {{ menu.products ? 'th-hdr__dropdown--mega w-full left-0 flex' : 'w-56' }}">
      <ul class="th-hdr__dropdownList {{ menu.products ? 'w-56 shrink-0 m-8 rtl:ml-0 ltr:mr-0' : '' }}">
        {% for submenu in menu.children %}
          {% include _self with {menu:submenu, is_root_menu:false} %}
        {% endfor %}
      </ul>

      {% if menu.products %}
        <div class="grow p-8 th-hdr__dropdownProducts">
          <div class="grid gap-4 grid-cols-4">
            {% for product in menu.products|slice(0, 4) %}
              <salla-product-card shadow-on-hover product="{{ product }}"></salla-product-card>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
</li>
