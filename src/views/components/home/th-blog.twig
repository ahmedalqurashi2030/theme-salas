{#
| Variable                       | Type      | Description
|--------------------------------|-----------|------------------------------------------------------
| component                      | object    | Contains merchant settings from twilight.json
| component.section_title        | string    | Section heading
| component.alaanoan_alfraae     | string    | Section subtitle
| component.show_controls        | boolean   | Slider arrows toggle
| component.autoplay             | boolean   | Slider autoplay toggle
| component.blog                 | Article[] | Selected blog articles
#}

{% set section_title = component.section_title|default('') %}
{% if section_title is iterable %}
  {% set section_title = section_title.value|default(section_title.ar|default(section_title.en|default(''))) %}
{% endif %}

{% set section_subtitle = component.alaanoan_alfraae|default(component.section_subtitle|default('')) %}
{% if section_subtitle is iterable %}
  {% set section_subtitle = section_subtitle.value|default(section_subtitle.ar|default(section_subtitle.en|default(''))) %}
{% endif %}
{% if section_subtitle in ['section_title', 'section_subtitle'] %}
  {% set section_subtitle = '' %}
{% endif %}

{% set blog_field = component.blog|default([]) %}
{% if blog_field is iterable and attribute(blog_field, 'selected') is defined and attribute(blog_field, 'selected') is iterable %}
  {% set raw_articles = attribute(blog_field, 'selected') %}
{% elseif blog_field is iterable and attribute(blog_field, 'value') is defined and attribute(blog_field, 'value') is iterable %}
  {% set raw_articles = attribute(blog_field, 'value') %}
{% elseif blog_field is iterable %}
  {% set raw_articles = blog_field %}
{% else %}
  {% set raw_articles = [] %}
{% endif %}

{% set selected_article_ids = [] %}
{% for item in raw_articles %}
  {% set selected_id = '' %}
  {% if item is iterable %}
    {% if item.id is defined and item.id %}
      {% set selected_id = item.id %}
    {% elseif item.blog is defined and item.blog and item.blog.id is defined and item.blog.id %}
      {% set selected_id = item.blog.id %}
    {% elseif item.value is defined and item.value %}
      {% set selected_id = item.value %}
    {% elseif item.key is defined and item.key %}
      {% set selected_id = item.key %}
    {% endif %}
  {% elseif item %}
    {% set selected_id = item %}
  {% endif %}

  {% if selected_id %}
    {% set selected_article_ids = selected_article_ids|merge([selected_id]) %}
  {% endif %}
{% endfor %}

{% set articles = [] %}
{% for item in raw_articles %}
  {% set article = item %}
  {% if item is iterable and attribute(item, 'blog') is defined and attribute(item, 'blog') %}
    {% set article = attribute(item, 'blog') %}
  {% endif %}

  {% set article_title = '' %}
  {% set article_url = '' %}
  {% set article_date = '' %}
  {% set article_comments = 0 %}
  {% set article_likes = 0 %}
  {% set article_image = '' %}
  {% set article_image_alt = '' %}
  {% set author_name = '' %}
  {% set author_url = '' %}
  {% set badge_label = '' %}

  {% if article is iterable %}
    {% set article_title = article.title|default(article.name|default(article.label|default(''))) %}
    {% set article_url = article.url|default(article.link|default(article.href|default(''))) %}
    {% if article_url is iterable %}
      {% set article_url = article_url.url|default(article_url.value|default('')) %}
    {% endif %}

    {% set article_date = article.created_at|default(article.published_at|default('')) %}
    {% set article_comments = article.comments_count|default(0) %}
    {% set article_likes = article.likes_count|default(0) %}

    {% set article_image = article.thumbnail|default('') %}
    {% if article.image is defined and article.image %}
      {% if article.image.url is defined %}
        {% set article_image = article.image.url %}
      {% elseif article.image.original is defined %}
        {% set article_image = article.image.original %}
      {% elseif article.image is not iterable %}
        {% set article_image = article.image %}
      {% endif %}
      {% if article.image.alt is defined and article.image.alt %}
        {% set article_image_alt = article.image.alt %}
      {% endif %}
    {% endif %}

    {% if article.author is defined and article.author %}
      {% if article.author.name is defined %}
        {% set author_name = article.author.name|default('') %}
      {% else %}
        {% set author_name = article.author|default('') %}
      {% endif %}
      {% if article.author.url is defined %}
        {% set author_url = article.author.url|default('') %}
      {% endif %}
    {% elseif article.author_name is defined and article.author_name %}
      {% set author_name = article.author_name %}
    {% endif %}

    {% if article.category is defined and article.category %}
      {% if article.category.name is defined %}
        {% set badge_label = article.category.name|default('') %}
      {% else %}
        {% set badge_label = article.category|default('') %}
      {% endif %}
    {% elseif article.tags is defined and article.tags|length %}
      {% set first_tag = article.tags|first %}
      {% if first_tag.name is defined %}
        {% set badge_label = first_tag.name|default('') %}
      {% else %}
        {% set badge_label = first_tag|default('') %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if not article_image %}
    {% set article_image = 'images/placeholder.png' | asset %}
  {% endif %}
  {% if not article_image_alt %}
    {% set article_image_alt = article_title %}
  {% endif %}
  {% if not article_url %}
    {% set article_url = '#' %}
  {% endif %}

  {% if article_title %}
    {% set articles = articles|merge([{
      'title': article_title,
      'url': article_url,
      'date': article_date,
      'comments_count': article_comments,
      'likes_count': article_likes,
      'image': article_image,
      'image_alt': article_image_alt,
      'author_name': author_name,
      'author_url': author_url,
      'badge': badge_label
    }]) %}
  {% endif %}
{% endfor %}

{% set show_controls_raw = component.show_controls|default(true) %}
{% if show_controls_raw is iterable %}
  {% set show_controls_raw = show_controls_raw.value|default(show_controls_raw.selected|default(show_controls_raw)) %}
{% endif %}

{% set autoplay_raw = component.autoplay|default(true) %}
{% if autoplay_raw is iterable %}
  {% set autoplay_raw = autoplay_raw.value|default(autoplay_raw.selected|default(autoplay_raw)) %}
{% endif %}

{% set show_controls = show_controls_raw in [true, 1, '1', 'true'] %}
{% set autoplay = autoplay_raw in [true, 1, '1', 'true'] %}
{% set has_multiple = articles|length > 1 %}

{% set slider_id = 'th-blog-' ~ (position ?? component.key|default('home')) %}

{% set slider_config = {
  "slidesPerView": 1.08,
  "spaceBetween": 12,
  "watchOverflow": true,
  "centeredSlides": false,
  "loop": articles|length > 4,
  "autoplay": (autoplay and has_multiple) ? {"delay": 3800, "disableOnInteraction": false} : false,
  "breakpoints": {
    "560": {"slidesPerView": 1.35, "spaceBetween": 14},
    "768": {"slidesPerView": 2.15, "spaceBetween": 16},
    "1024": {"slidesPerView": 3.15, "spaceBetween": 18},
    "1280": {"slidesPerView": 4, "spaceBetween": 20}
  }
} %}

<section class="s-block th-home-blog">
  <div class="container">
    <header class="th-home-blog__header">
      {% if section_title %}
        <h2 class="th-home-blog__title">{{ section_title }}</h2>
      {% endif %}
      {% if section_subtitle %}
        <p class="th-home-blog__subtitle">{{ section_subtitle }}</p>
      {% endif %}
    </header>

    {% if articles|length %}
      <salla-slider
        id="{{ slider_id }}"
        class="th-home-blog__slider s-slider-wrapper"
        type="carousel"
        show-controls="{{ (show_controls and has_multiple) ? 'true' : 'false' }}"
        auto-play="{{ (autoplay and has_multiple) ? 'true' : 'false' }}"
        slider-config='{{ slider_config|json_encode|e("html_attr") }}'
        {% if show_controls and has_multiple %}controls-outer{% endif %}
        {% if has_multiple %}pagination{% endif %}>
        <div slot="items">
          {% for article in articles %}
            <div class="swiper-slide th-home-blog__slide">
              <article class="th-home-blog-card">
                <a href="{{ article.url|e('html_attr') }}" class="th-home-blog-card__media-link" aria-label="{{ article.title|e('html_attr') }}">
                  <div class="th-home-blog-card__media">
                    <img
                      src="{{ 'images/s-empty.png' | asset }}"
                      data-src="{{ article.image|e('html_attr') }}"
                      alt="{{ article.image_alt|e('html_attr') }}"
                      class="lazy th-home-blog-card__image">
                  </div>

                  {% if article.date %}
                    <time class="th-home-blog-card__date" datetime="{{ article.date|date('c') }}">
                      <span>{{ article.date|date('d') }}</span>
                      <small>{{ article.date|date('M') }}</small>
                    </time>
                  {% endif %}

                  {% if article.badge %}
                    <span class="th-home-blog-card__badge th-home-blog-card__badge--{{ (loop.index0 % 4) + 1 }}">
                      {{ article.badge }}
                    </span>
                  {% endif %}
                </a>

                <div class="th-home-blog-card__body">
                  <h3 class="th-home-blog-card__title">
                    <a href="{{ article.url|e('html_attr') }}">{{ article.title }}</a>
                  </h3>

                  <footer class="th-home-blog-card__meta">
                    <div class="th-home-blog-card__stats">
                      <span class="th-home-blog-card__stat">
                        <i class="sicon-chat"></i>
                        {% if article.comments_count %}
                          <span>{{ article.comments_count }}</span>
                        {% endif %}
                      </span>
                      <span class="th-home-blog-card__stat">
                        <i class="sicon-thumbs-up"></i>
                        {% if article.likes_count %}
                          <span>{{ article.likes_count }}</span>
                        {% endif %}
                      </span>
                    </div>

                    {% if article.author_name %}
                      <div class="th-home-blog-card__author">
                        <span class="th-home-blog-card__author-dot" aria-hidden="true"></span>
                        {% if article.author_url %}
                          <a href="{{ article.author_url|e('html_attr') }}">{{ article.author_name }}</a>
                        {% else %}
                          <span>{{ article.author_name }}</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </footer>
                </div>
              </article>
            </div>
          {% endfor %}
        </div>
      </salla-slider>
    {% else %}
      <div
        class="th-home-blog__fallback js-th-blog-fallback"
        data-limit="8"
        data-selected-ids='{{ selected_article_ids|json_encode|e("html_attr") }}'>
        <div class="th-home-blog__fallback-grid js-th-blog-grid"></div>
        <div class="text-center py-10 text-gray-500 text-sm js-th-blog-empty" hidden>
          {{ trans('pages.blog_categories.no_articles') }}
        </div>
      </div>
    {% endif %}
  </div>
</section>
