{# Component: Home blog — متوافق مع twilight.json (field id = posts) #}

{# --- Normalize top-level fields --- #}
{% set section_title = component.section_title|default('') %}
{% if section_title is iterable %}
  {% set section_title = section_title.value|default(section_title.ar|default(section_title.en|default(''))) %}
{% endif %}

{% set section_subtitle = component.section_subtitle|default(component.alaanoan_alfraae|default('')) %}
{% if section_subtitle is iterable %}
  {% set section_subtitle = section_subtitle.value|default(section_subtitle.ar|default(section_subtitle.en|default(''))) %}
{% endif %}
{% if section_subtitle in ['section_title','section_subtitle'] %}
  {% set section_subtitle = '' %}
{% endif %}

{# --- Normalize posts field (selected / value / raw) --- #}
{% set posts_field = component.posts|default([]) %}
{% if posts_field is iterable and attribute(posts_field,'selected') is defined and attribute(posts_field,'selected') is iterable %}
  {% set raw_posts = attribute(posts_field,'selected') %}
{% elseif posts_field is iterable and attribute(posts_field,'value') is defined and attribute(posts_field,'value') is iterable %}
  {% set raw_posts = attribute(posts_field,'value') %}
{% elseif posts_field is iterable %}
  {% set raw_posts = posts_field %}
{% else %}
  {% set raw_posts = [] %}
{% endif %}

{# --- Fallback to latest if none selected and store API available --- #}
{% set posts = [] %}
{% if raw_posts is iterable and raw_posts|length %}
  {% set posts = raw_posts %}
{% else %}
  {% if store is defined and store.posts is defined and store.posts.latest is defined %}
    {% set posts = store.posts.latest().limit(5).get() %}
  {% endif %}
{% endif %}

{# --- Normalize controls/autoplay --- #}
{% set show_controls_raw = component.show_controls|default(true) %}
{% if show_controls_raw is iterable %}
  {% set show_controls_raw = show_controls_raw.value|default(show_controls_raw.selected|default(show_controls_raw)) %}
{% endif %}
{% set autoplay_raw = component.autoplay|default(true) %}
{% if autoplay_raw is iterable %}
  {% set autoplay_raw = autoplay_raw.value|default(autoplay_raw.selected|default(autoplay_raw)) %}
{% endif %}
{% set show_controls = show_controls_raw in [true,1,'1','true'] %}
{% set autoplay = autoplay_raw in [true,1,'1','true'] %}

{# --- If still empty: set sample posts for dev (remove in production) --- #}
{% if posts is empty %}
  {% set posts = [
    {"title":"مقال تجريبي 1","url":"#","published_at":"2026-02-01","image":{"url": asset('images/placeholder.png')},"author":{"name":"محرر"},"likes_count":0,"comments_count":0},
    {"title":"مقال تجريبي 2","url":"#","published_at":"2026-01-28","image":{"url": asset('images/placeholder.png')},"author":{"name":"محرر"},"likes_count":0,"comments_count":0}
  ] %}
{% endif %}

{# --- Slider config --- #}
{% set slides_count = posts is iterable ? posts|length : 0 %}
{% set slider_config = {
  "slidesPerView": 1.2,
  "spaceBetween": 16,
  "autoplay": (autoplay and slides_count > 1) ? {"delay":3500,"disableOnInteraction":false} : false,
  "loop": slides_count > 3,
  "breakpoints": {
    "640": {"slidesPerView":2,"spaceBetween":20},
    "768": {"slidesPerView":3,"spaceBetween":30},
    "1024": {"slidesPerView":4,"spaceBetween":30}
  }
} %}

<section class="s-block container th-home-blog">
  {% if section_title %}
    <div class="s-block__title">
      <h2>{{ section_title }}</h2>
      {% if section_subtitle %}<p class="s-block__subtitle">{{ section_subtitle }}</p>{% endif %}
    </div>
  {% endif %}

  {% if slides_count %}
    <salla-slider
      id="home-blog-slider"
      class="home-blog-slider"
      slider-config='{{ slider_config|json_encode|e("html_attr") }}'
      {% if slides_count > 1 and show_controls %}show-controls{% endif %}
      {% if slides_count > 1 and autoplay %}auto-play="true"{% endif %}
      {% if slides_count > 1 %}pagination{% endif %}>

      <div slot="slides">
        {% for item in posts %}
          {% set p = item %}
          {% if item is iterable and attribute(item,'post') is defined %}
            {% set p = attribute(item,'post') %}
          {% endif %}

          {# Determine image URL robustly #}
          {% set img = '' %}
          {% if p is iterable %}
            {# common fields: thumbnail, image, cover, featured_image, poster ... try many #}
            {% if p.thumbnail is defined and p.thumbnail %}{% set img = p.thumbnail %}{% endif %}
            {% if not img and p.featured_image is defined and p.featured_image %}{% set img = p.featured_image %}{% endif %}
            {% if not img and p.cover is defined and p.cover %}{% set img = p.cover %}{% endif %}
            {% if not img and p.image is defined and p.image %}
              {% if p.image.url is defined and p.image.url %}{% set img = p.image.url %}
              {% elseif p.image.original is defined and p.image.original %}{% set img = p.image.original %}
              {% elseif p.image.path is defined and p.image.path %}{% set img = p.image.path %}
              {% elseif p.image is not iterable and p.image %}{% set img = p.image %}{% endif %}
            {% endif %}
            {# sometimes thumbnail is object #}
            {% if img is iterable and img.url is defined %}{% set img = img.url %}{% endif %}
          {% endif %}

          {# final fallback to placeholder #}
          {% if not img %}{% set img = 'images/placeholder.png'|asset %}{% endif %}

          {# if img is relative (not http) convert to asset(), else keep absolute URL #}
          {% if img is defined and img and (img[:4] != 'http') %}
            {# avoid double asset() if already absolute path starting with '/' we still need asset() #}
            {% if img[:1] == '/' %}
              {% set img = asset(img|slice(1)) %}
            {% else %}
              {% set img = asset(img) %}
            {% endif %}
          {% endif %}

          <div class="swiper-slide">
            <article class="th-home-blog-card">
              {% if p is iterable %}
                <a href="{{ p.url|default('#') }}" class="th-home-blog-card__media">
                  {# prefer salla-image when available, else fallback to img #}
                  {% if "salla-image" is defined %}
                    <salla-image src="{{ img }}" alt="{{ p.title|default('') }}" class="th-home-blog-card__image" />
                  {% else %}
                    <img src="{{ img }}" alt="{{ p.title|default('') }}" class="th-home-blog-card__image" />
                  {% endif %}
                  {% if p.category %}<span class="th-home-blog-card__badge">{{ p.category.name|default(p.category) }}</span>{% endif %}
                </a>

                <div class="th-home-blog-card__body">
                  <div class="meta text-sm text-gray-500 mb-2">
                    {% if p.published_at %}<time>{{ p.published_at|date('d M, Y') }}</time>{% endif %}
                    {% if p.author is defined and p.author.name %} • <span>{{ p.author.name }}</span>{% endif %}
                  </div>

                  <h3 class="title"><a href="{{ p.url|default('#') }}">{{ p.title|default('') }}</a></h3>

                  <div class="meta-actions text-sm text-gray-500 mt-3">
                    <span class="likes mr-3">{{ p.likes_count|default(0) }}</span>
                    <span class="comments">{{ p.comments_count|default(0) }}</span>
                  </div>
                </div>

              {% else %}
                <div class="p-4">
                  <h3 class="title">{{ p }}</h3>
                </div>
              {% endif %}
            </article>
          </div>
        {% endfor %}
      </div>
    </salla-slider>
  {% else %}
    <div class="admin-hint">لا توجد مقالات لعرضها.</div>
  {% endif %}
</section>