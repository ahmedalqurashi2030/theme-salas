{# Component: Home blog — robust image extraction and fallbacks (Salla-friendly) #}

{# ... (بقية القالب كما لديك) ... #}

{# داخل حلقة عرض المقالات، استخدم هذا الجزء لاختيار الصورة robustly #}
	{% for item in posts %}
	{% set p = item %}
		{% if item is iterable and attribute(item,'post') is defined %}
	{% set p = attribute(item,'post') %}
	{% endif %}

	{# ---------- DEBUG (مؤقت) - اطبع أول صورة مرة واحدة فقط ---------- #}{% if loop.index0 == 0 %}
		{# قم بإلغاء تعليق السطر التالي مؤقتًا إذا تريد طباعة كائن الـ post للـ debug #}
		{# <pre style="background:#fff;padding:10px;border:1px solid #ddd;">{{ p|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre> #}
	{% endif %}
	{# --------------------------------------------------------------- #}

	{# Determine image URL robustly #}
	{% set img = '' %}

	{% if p is iterable %}
		{# try commonly used fields in order of likelihood #}
		{% if p.image is defined and p.image %}
			{% if p.image is iterable %}
				{% if p.image.url is defined and p.image.url %}
					{% set img = p.image.url %}
				{% elseif p.image.original is defined and p.image.original %}
					{% set img = p.image.original %}
				{% elseif p.image.path is defined and p.image.path %}
					{% set img = p.image.path %}
				{% endif %}
			{% else %}
				{% set img = p.image %}
			{% endif %}
		{% endif %}

		{% if not img and p.thumbnail is defined and p.thumbnail %}
			{% set img = p.thumbnail %}
		{% endif %}
		{% if not img and p.featured_image is defined and p.featured_image %}
			{% set img = p.featured_image %}
		{% endif %}
		{% if not img and p.cover is defined and p.cover %}
			{% set img = p.cover %}
		{% endif %}
		{% if not img and p.poster is defined and p.poster %}
			{% set img = p.poster %}
		{% endif %}
		{% if not img and p.media is defined and p.media is iterable and p.media|length %}
			{% set first_media = p.media|first %}
			{% if first_media is iterable %}
				{% if first_media.url is defined and first_media.url %}
					{% set img = first_media.url %}
				{% elseif first_media.original is defined and first_media.original %}
					{% set img = first_media.original %}
				{% elseif first_media.path is defined and first_media.path %}
					{% set img = first_media.path %}
				{% endif %}
			{% elseif first_media %}
				{% set img = first_media %}
			{% endif %}
		{% endif %}

		{% if not img and p.images is defined and p.images is iterable and p.images|length %}
			{% set im0 = p.images|first %}
			{% if im0 is iterable and im0.url is defined %}
				{% set img = im0.url %}
			{% elseif im0 %}
				{% set img = im0 %}
			{% endif %}
		{% endif %}

		{% if not img and p.thumb is defined and p.thumb %}
			{% set img = p.thumb %}
		{% endif %}
		{% if not img and p.picture is defined and p.picture %}
			{% set img = p.picture %}
		{% endif %}
		{% if not img and p.image_url is defined and p.image_url %}
			{% set img = p.image_url %}
		{% endif %}
	{% endif %}

	{# final fallback to placeholder #}
	{% if not img %}
		{% set img = 'images/placeholder.png'|asset %}
	{% endif %}

	{# If img is iterable/object with url #}
	{% if img is iterable and img.url is defined %}
		{% set img = img.url %}
	{% endif %}

	{# If img is relative (no http), try to convert to absolute via asset() or store base url if available #}
	{% if img is defined and img and (img[:4] != 'http') %}
		{% if img[:1] == '/' %}
			{% set img = asset(img|slice(1)) %}
		{% else %}
			{% set img = asset(img) %}
		{% endif %}
	{% endif %}

	<div class="swiper-slide">
		<article class="th-home-blog-card">
			<a
				href="{{ p.url|default('#') }}" class="th-home-blog-card__media">
				{# Use plain <img> with lazy loading and srcset; salla-image fallback #}
				<img src="{{ img }}" alt="{{ p.title|default('') }}" loading="lazy" class="th-home-blog-card__image" onerror="this.onerror=null;this.src='{{ 'images/placeholder.png'|asset }}'">
			</a>

			<div class="th-home-blog-card__body">
				<h3 class="title">
					<a href="{{ p.url|default('#') }}">{{ p.title|default('') }}</a>
				</h3>
				<div class="meta">
					{% if p.published_at %}
						<time>{{ p.published_at|date('d M, Y') }}</time>
					{% endif %}
					{% if p.author is defined and p.author.name %}
						•
						<span>{{ p.author.name }}</span>
					{% endif %}
				</div>
			</div>
		</article>
	</div>
{% endfor %}
