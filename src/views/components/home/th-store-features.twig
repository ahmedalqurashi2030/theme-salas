{#
| Variable                        | Type   | Description
|---------------------------------|--------|---------------------------------------
| component.section_title         | string | Main heading for section
| component.section_subtitle      | string | Subtitle under heading
| component.show_mobile_dots      | mixed  | Show/hide mobile dots navigation
| component.card_layout           | mixed  | Card content layout (stacked/inline-right)
| component.features              | array  | Feature cards collection
| component.features[].title      | string | Card title
| component.features[].description| string | Card description (richtext)
| component.features[].icon       | string | Salla icon class
#}

{% set features = component.features|default([]) %}
{% set card_layout = 'stacked' %}
{% set show_mobile_dots = true %}

{# Show dots switch (new) with fallback for old mobile_nav_style setting #}
{% set show_mobile_dots_raw = component.show_mobile_dots|default(true) %}
{% if show_mobile_dots_raw is iterable %}
	{% if attribute(show_mobile_dots_raw, 'selected') is defined %}
		{% set show_mobile_dots_raw = attribute(show_mobile_dots_raw, 'selected') %}
	{% else %}
		{% set show_mobile_dots_raw = attribute(show_mobile_dots_raw, 'value')|default(show_mobile_dots_raw) %}
	{% endif %}
{% endif %}

{% if component.show_mobile_dots is not defined and component.mobile_nav_style is defined %}
	{% set old_mobile_nav_raw = component.mobile_nav_style.selected[0].label
		|default(component.mobile_nav_style.selected[0].value
		|default(component.mobile_nav_style[0].label
		|default(component.mobile_nav_style[0].value
		|default(component.mobile_nav_style.value
		|default(component.mobile_nav_style|default('dots'))))))|lower %}
	{% set show_mobile_dots_raw = old_mobile_nav_raw == 'thumbnails' ? false : true %}
{% endif %}

{% if show_mobile_dots_raw in [false, 0, '0', 'false', 'off', 'no'] %}
	{% set show_mobile_dots = false %}
{% endif %}

{# Card layout setting #}
{% set card_layout_raw = component.card_layout.selected[0].label
	|default(component.card_layout.selected[0].value
	|default(component.card_layout[0].label
	|default(component.card_layout[0].value
	|default(component.card_layout.value
	|default(component.card_layout|default('stacked'))))))|lower %}
{% if card_layout_raw in ['stacked', 'inline-right'] %}
	{% set card_layout = card_layout_raw %}
{% elseif 'اليمين' in card_layout_raw %}
	{% set card_layout = 'inline-right' %}
{% elseif 'أعلى' in card_layout_raw or 'اعلى' in card_layout_raw %}
	{% set card_layout = 'stacked' %}
{% endif %}

{% set is_inline_layout = card_layout == 'inline-right' %}

{% if features|length >= 1 %}
	<section class="th-store-features s-block {{ is_inline_layout ? 'th-store-features--inline' : 'th-store-features--stacked' }}" data-th-store-features data-card-layout="{{ card_layout }}">
		<div class="container">
			<header class="s-block__title th-store-features__header justify-center mb-8 md:mb-14">
				<div class="right-side th-store-features__header-inner max-w-[51rem] mx-auto px-4 md:px-0">
					{% if component.section_title %}
						<h2 class="th-store-features__title">{{ component.section_title }}</h2>
					{% endif %}
					{% if component.section_subtitle %}
						<p class="th-store-features__subtitle">{{ component.section_subtitle }}</p>
					{% endif %}
				</div>
			</header>

			<div class="th-store-features__slider flex gap-4 overflow-x-auto pt-14 pb-7 px-4 md:px-0 md:pt-15 md:grid md:grid-cols-4 md:gap-6" data-th-store-features-track>
				{% for feature in features %}
					<article class="th-store-features__card" data-feature-index="{{ loop.index0 }}">
						<div class="th-store-features__card-inner flex {{ is_inline_layout ? 'flex-row items-start text-start gap-4 px-5 py-6 md:px-6 md:py-7' : 'flex-col items-center text-center px-5 pt-12 pb-8 md:px-5 md:pt-14 md:pb-8' }} rounded-[1.35rem] md:rounded-[1.75rem]">
							<div class="th-store-features__icon-wrap flex items-center justify-center {{ is_inline_layout ? 'th-store-features__icon-wrap--inline w-14 h-14 md:w-16 md:h-16' : 'w-[4.1rem] h-[4.1rem] -top-[2.05rem] md:w-[4.9rem] md:h-[4.9rem] md:-top-[2.45rem] lg:w-[5.7rem] lg:h-[5.7rem] lg:-top-[2.85rem]' }}">
								<i class="{{ feature.icon|default('sicon-store') }} th-store-features__icon text-[1.9rem] md:text-[2.3rem]"></i>
							</div>

							<div class="th-store-features__content {{ is_inline_layout ? 'min-w-0 flex-1' : '' }}">
								{% if feature.title %}
									<h3 class="th-store-features__card-title m-0 {{ is_inline_layout ? 'mb-2' : 'mb-[0.9rem]' }}">{{ feature.title }}</h3>
								{% endif %}

								{% if feature.description %}
									<div class="th-store-features__card-description">{{ feature.description|raw }}</div>
								{% endif %}
							</div>
						</div>
					</article>
				{% endfor %}
			</div>

			{% if show_mobile_dots %}
				<div class="th-store-features__mobile-nav">
					<div class="th-store-features__dots">
						{% for feature in features %}
							<button type="button" class="th-store-features__dot {{ loop.first ? 'is-active' : '' }}" data-go-to="{{ loop.index0 }}" aria-label="Go to card {{ loop.index }}"></button>
						{% endfor %}
					</div>

					<div class="th-store-features__counter">
						<span data-th-store-features-current>1</span>
						<span>/</span>
						<span>{{ features|length }}</span>
					</div>
				</div>
			{% endif %}
		</div>
	</section>

	<script>
		(() => {
			const sections = document.querySelectorAll('[data-th-store-features]');
			if (!sections.length) return;

			const debounce = (fn, wait = 120) => {
				let timeout;
				return (...args) => {
					clearTimeout(timeout);
					timeout = setTimeout(() => fn(...args), wait);
				};
			};

			sections.forEach((section) => {
				const track = section.querySelector('[data-th-store-features-track]');
				if (!track) return;

				const cards = section.querySelectorAll('.th-store-features__card');
				const dots = section.querySelectorAll('.th-store-features__dot');
				const counter = section.querySelector('[data-th-store-features-current]');
				const total = cards.length;
				if (!total) return;

				let activeIndex = 0;
				let isMobile = window.innerWidth < 1024;

				const setActive = (index) => {
					activeIndex = Math.max(0, Math.min(index, total - 1));
					dots.forEach((dot, i) => dot.classList.toggle('is-active', i === activeIndex));
					if (counter) counter.textContent = String(activeIndex + 1);
				};

				const scrollToCard = (index) => {
					const card = cards[index];
					if (!card) return;

					const trackRect = track.getBoundingClientRect();
					const cardRect = card.getBoundingClientRect();
					const deltaX = (cardRect.left + cardRect.width / 2) - (trackRect.left + trackRect.width / 2);

					track.scrollBy({ left: deltaX, behavior: 'smooth' });
					setActive(index);
				};

				const updateFromScroll = debounce(() => {
					if (!isMobile) return;

					const center = track.getBoundingClientRect().left + track.clientWidth / 2;
					let nextIndex = 0;
					let minDistance = Infinity;

					cards.forEach((card, index) => {
						const cardRect = card.getBoundingClientRect();
						const cardCenter = cardRect.left + cardRect.width / 2;
						const distance = Math.abs(cardCenter - center);
						if (distance < minDistance) {
							minDistance = distance;
							nextIndex = index;
						}
					});

					setActive(nextIndex);
				}, 120);

				track.addEventListener('scroll', updateFromScroll);

				section.querySelectorAll('[data-go-to]').forEach((button) => {
					button.addEventListener('click', (event) => {
						event.preventDefault();
						const index = Number(button.dataset.goTo || 0);
						scrollToCard(index);
					});
				});

				window.addEventListener('resize', debounce(() => {
					isMobile = window.innerWidth < 1024;
				}, 200));

				setActive(0);
			});
		})();
	</script>
{% endif %}
