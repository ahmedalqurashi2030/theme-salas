{#
| Variable                        | Type   | Description
|---------------------------------|--------|---------------------------------------
| component.section_title         | string | Main heading for section
| component.section_subtitle      | string | Subtitle under heading
| component.mobile_nav_style      | mixed  | Mobile nav style (dots/thumbnails)
| component.card_layout           | mixed  | Card content layout (stacked/inline-right)
| component.features              | array  | Feature cards collection
| component.features[].title      | string | Card title
| component.features[].description| string | Card description (richtext)
| component.features[].icon       | string | Salla icon class
| component.features[].stats_badge| string | Small stats badge
#}

{% set features = component.features|default([]) %}
{% set mobile_nav_style = 'dots' %}
{% set card_layout = 'stacked' %}

{% if component.mobile_nav_style is iterable and component.mobile_nav_style|length %}
	{% set first_style = component.mobile_nav_style|first %}
	{% if first_style.label is defined and first_style.label in ['dots', 'thumbnails'] %}
		{% set mobile_nav_style = first_style.label %}
	{% elseif first_style.value is defined and first_style.value in ['dots', 'thumbnails'] %}
		{% set mobile_nav_style = first_style.value %}
	{% endif %}
{% elseif component.mobile_nav_style in ['dots', 'thumbnails'] %}
	{% set mobile_nav_style = component.mobile_nav_style %}
{% endif %}

{% if component.card_layout is iterable and component.card_layout|length %}
	{% set first_layout = component.card_layout|first %}
	{% if first_layout.label is defined and first_layout.label in ['stacked', 'inline-right'] %}
		{% set card_layout = first_layout.label %}
	{% elseif first_layout.value is defined and first_layout.value in ['stacked', 'inline-right'] %}
		{% set card_layout = first_layout.value %}
	{% endif %}
{% elseif component.card_layout in ['stacked', 'inline-right'] %}
	{% set card_layout = component.card_layout %}
{% endif %}

{% set is_inline_layout = card_layout == 'inline-right' %}

{% if features|length >= 1 %}
	<section class="th-store-features s-block {{ is_inline_layout ? 'th-store-features--inline' : 'th-store-features--stacked' }}" data-th-store-features data-nav-style="{{ mobile_nav_style }}" data-card-layout="{{ card_layout }}">
		<div class="container">
			<header class="s-block__title th-store-features__header justify-center mb-8 md:mb-14">
				<div class="right-side th-store-features__header-inner max-w-[51rem] mx-auto px-4 md:px-0">
				{% if component.section_title %}
					<h2 class="th-store-features__title">{{ component.section_title }}</h2>
				{% endif %}
				{% if component.section_subtitle %}
					<p class="th-store-features__subtitle">{{ component.section_subtitle }}</p>
				{% endif %}
				</div>
			</header>

			<div class="th-store-features__slider flex gap-4 overflow-x-auto pt-14 pb-7 px-4 md:px-0 md:pt-15 md:grid md:grid-cols-4 md:gap-6" data-th-store-features-track>
				{% for feature in features %}
					<article class="th-store-features__card" data-feature-index="{{ loop.index0 }}">
						<div class="th-store-features__card-inner flex {{ is_inline_layout ? 'flex-row items-start text-start gap-4 px-5 py-6 md:px-6 md:py-7' : 'flex-col items-center text-center px-5 pt-12 pb-8 md:px-5 md:pt-14 md:pb-8' }} rounded-[1.35rem] md:rounded-[1.75rem]">
							<div class="th-store-features__icon-wrap flex items-center justify-center {{ is_inline_layout ? 'th-store-features__icon-wrap--inline w-14 h-14 md:w-16 md:h-16' : 'w-[4.1rem] h-[4.1rem] -top-[2.05rem] md:w-[4.9rem] md:h-[4.9rem] md:-top-[2.45rem] lg:w-[5.7rem] lg:h-[5.7rem] lg:-top-[2.85rem]' }}">
								<i class="{{ feature.icon|default('sicon-store') }} th-store-features__icon text-[1.9rem] md:text-[2.3rem]"></i>
							</div>

							<div class="th-store-features__content {{ is_inline_layout ? 'min-w-0 flex-1' : '' }}">

							{% if feature.title %}
								<h3 class="th-store-features__card-title m-0 {{ is_inline_layout ? 'mb-2' : 'mb-[0.9rem]' }}">{{ feature.title }}</h3>
							{% endif %}

							{% if feature.description %}
								<div class="th-store-features__card-description">{{ feature.description|raw }}</div>
							{% endif %}
							</div>
						</div>
					</article>
				{% endfor %}
			</div>

			<div class="th-store-features__mobile-nav" data-th-store-features-nav="dots">
				<div class="th-store-features__dots">
					{% for feature in features %}
						<button type="button" class="th-store-features__dot {{ loop.first ? 'is-active' : '' }}" data-go-to="{{ loop.index0 }}" aria-label="{{ 'انتقل للبطاقة' }} {{ loop.index }}"></button>
					{% endfor %}
				</div>

				<div class="th-store-features__counter">
					<span data-th-store-features-current>1</span>
					<span>/</span>
					<span>{{ features|length }}</span>
				</div>
			</div>

			<div class="th-store-features__mobile-nav th-store-features__mobile-nav--hidden" data-th-store-features-nav="thumbnails">
				<div class="th-store-features__thumbs">
					{% for feature in features %}
						<button type="button" class="th-store-features__thumb {{ loop.first ? 'is-active' : '' }}" data-go-to="{{ loop.index0 }}" aria-label="{{ feature.title|default('ميزة') }}">
							<i class="{{ feature.icon|default('sicon-store') }}"></i>
						</button>
					{% endfor %}
				</div>
			</div>
		</div>
	</section>

	<script>
		(() => {
const sections = document.querySelectorAll('[data-th-store-features]');
if (! sections.length) 
return;



const debounce = (fn, wait = 120) => {
let timeout;
return(...args) => {
clearTimeout(timeout);
timeout = setTimeout(() => fn(...args), wait);
};
};

sections.forEach((section) => {
const track = section.querySelector('[data-th-store-features-track]');
if (! track) 
return;



const cards = section.querySelectorAll('.th-store-features__card');
const dots = section.querySelectorAll('.th-store-features__dot');
const thumbs = section.querySelectorAll('.th-store-features__thumb');
const counter = section.querySelector('[data-th-store-features-current]');
const mobileNavs = section.querySelectorAll('[data-th-store-features-nav]');
const total = cards.length;
if (! total) 
return;



let activeIndex = 0;
let isMobile = window.innerWidth < 1024;
const defaultStyle = section.dataset.navStyle === 'thumbnails' ? 'thumbnails' : 'dots';

const setActive = (index) => {
activeIndex = Math.max(0, Math.min(index, total - 1));
dots.forEach((dot, i) => dot.classList.toggle('is-active', i === activeIndex));
thumbs.forEach((thumb, i) => thumb.classList.toggle('is-active', i === activeIndex));
if (counter) 
counter.textContent = String(activeIndex + 1);


};

const scrollToCard = (index) => {
const card = cards[index];
if (! card) 
return;



// Robust centering for both LTR/RTL (works better than offset/scrollLeft math)
const trackRect = track.getBoundingClientRect();
const cardRect = card.getBoundingClientRect();
const deltaX = (cardRect.left + cardRect.width / 2) - (trackRect.left + trackRect.width / 2);

track.scrollBy({left: deltaX, behavior: 'smooth'});

setActive(index);
};

const updateVisibleNav = () => {
mobileNavs.forEach((nav) => nav.classList.add('th-store-features__mobile-nav--hidden'));
if (! isMobile) 
return;



const activeNav = section.querySelector(`[data-th-store-features-nav="${defaultStyle}"]`);
if (activeNav) 
activeNav.classList.remove('th-store-features__mobile-nav--hidden');


};

const updateFromScroll = debounce(() => {
if (! isMobile) 
return;



const center = track.getBoundingClientRect().left + track.clientWidth / 2;
let nextIndex = 0;
let minDistance = Infinity;

cards.forEach((card, index) => {
const cardRect = card.getBoundingClientRect();
const cardCenter = cardRect.left + cardRect.width / 2;
const distance = Math.abs(cardCenter - center);
if (distance < minDistance) {
minDistance = distance;
nextIndex = index;
}
});

setActive(nextIndex);
}, 120);

track.addEventListener('scroll', updateFromScroll);

section.querySelectorAll('[data-go-to]').forEach((button) => {
button.addEventListener('click', (event) => {
event.preventDefault();
const index = Number(button.dataset.goTo || 0);
scrollToCard(index);
});
});

window.addEventListener('resize', debounce(() => {
isMobile = window.innerWidth < 1024;
updateVisibleNav();
}, 200));

updateVisibleNav();
setActive(0);
});
})();
	</script>
{% endif %}
